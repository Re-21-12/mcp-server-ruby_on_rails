#!/bin/bash -e
# Ensure SECRET_KEY_BASE exists (must be set before loading Rails)
if [ -z "${SECRET_KEY_BASE:-}" ]; then
  export SECRET_KEY_BASE=$(bin/rails secret)
fi

# Only run db:prepare when the container is started to run the Rails server
# (supports: rails server, bin/rails server, ./bin/rails server, /full/path/bin/rails server)
if [ "$2" = "server" ]; then
  case "$1" in
    rails|bin/rails|./bin/rails|*/bin/rails)
      ./bin/rails db:prepare
      ;;
  esac
fi

exec "$@"